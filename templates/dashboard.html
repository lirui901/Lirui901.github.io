<!DOCTYPE html>
<html lang="en">
<head>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <meta charset="UTF-8">
    <title>ç­çº§ç®¡ç†ç³»ç»Ÿ</title>
    <style>
        /* å¤åˆ¶ä¹‹å‰ç­çº§ç®¡ç†ç³»ç»Ÿçš„å®Œæ•´æ ·å¼ï¼Œæ­¤å¤„ç•¥å»ï¼Œå®é™…ä½¿ç”¨æ—¶è¯·å°†æ ·å¼ç²˜è´´åœ¨æ­¤ */
        /* å¯ä»ä¹‹å‰çš„ Node.js ç‰ˆæœ¬ä¸­å¤åˆ¶æ‰€æœ‰æ ·å¼ï¼Œä¸ºäº†ç®€æ´ï¼Œæ­¤å¤„ç”¨æ³¨é‡Šä»£æ›¿ */
    </style>
</head>
<body>
    <div class="app-card">
        <div class="header">
            <h1>ğŸ“ ç­çº§ç®¡ç†ç³»ç»Ÿ <span id="welcomeUser"></span></h1>
            <div class="file-controls">
                <button class="file-btn" onclick="logout()">ğŸšª é€€å‡ºç™»å½•</button>
            </div>
        </div>

        <div class="main">
            <!-- å·¦ä¾§ç­çº§åˆ—è¡¨ -->
            <div class="classes-panel">
                <div class="panel-header">
                    <h2>ğŸ“Œ ç­çº§åˆ—è¡¨</h2>
                    <button id="addClassBtn" title="æ–°å»ºç­çº§">+</button>
                </div>
                <ul id="classList"></ul>
            </div>

            <!-- å³ä¾§å­¦ç”Ÿç®¡ç† -->
            <div class="students-panel">
                <div class="students-header">
                    <h2>ğŸ‘¥ å­¦ç”Ÿåå•</h2>
                    <span id="currentClassName">æœªé€‰ä¸­ç­çº§</span>
                </div>

                <div class="student-form">
                    <input type="text" id="studentName" placeholder="å­¦ç”Ÿå§“å">
                    <input type="number" id="studentAge" placeholder="å¹´é¾„">
                    <button id="addStudentBtn">â• æ·»åŠ å­¦ç”Ÿ</button>
                    <button id="cancelEditBtn" style="display: none;">âœ– å–æ¶ˆ</button>
                </div>

                <div class="table-wrapper">
                    <table>
                        <thead><tr><th>å§“å</th><th>å¹´é¾„</th><th>æ“ä½œ</th></tr></thead>
                        <tbody id="studentsTbody"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        // å…¨å±€å˜é‡
        let classes = [];
        let selectedClassId = null;
        let editStudentId = null;

        // å·¥å…·å‡½æ•°ï¼šè½¬ä¹‰ HTML
        function escapeHtml(text) {
            return String(text).replace(/[&<>"]/g, function(c) {
                if(c === '&') return '&amp;';
                if(c === '<') return '&lt;';
                if(c === '>') return '&gt;';
                if(c === '"') return '&quot;';
                return c;
            });
        }

        // åŠ è½½ç­çº§åˆ—è¡¨
        async function loadClasses() {
            const res = await fetch('/api/classes');
            if (res.ok) {
                classes = await res.json();
                renderClasses();
            }
        }

        function renderClasses() {
            const list = document.getElementById('classList');
            list.innerHTML = '';
            classes.forEach(cls => {
                const li = document.createElement('li');
                li.className = 'class-item' + (selectedClassId === cls.id ? ' active' : '');
                li.dataset.classId = cls.id;
                li.innerHTML = `
                    <span class="class-name">${escapeHtml(cls.name)}</span>
                    <span class="class-actions">
                        <button class="edit-class-btn" data-action="editClass" data-class-id="${cls.id}">âœï¸</button>
                        <button class="delete-class-btn" data-action="deleteClass" data-class-id="${cls.id}">ğŸ—‘ï¸</button>
                    </span>
                `;
                list.appendChild(li);
            });
        }

        // åŠ è½½å­¦ç”Ÿ
        async function loadStudents(classId) {
            const res = await fetch(`/api/classes/${classId}/students`);
            if (res.ok) {
                const students = await res.json();
                renderStudents(students);
            }
        }

        function renderStudents(students) {
            const tbody = document.getElementById('studentsTbody');
            if (students.length === 0) {
                tbody.innerHTML = `<tr class="empty-row"><td colspan="3">æš‚æ— å­¦ç”Ÿï¼Œè¯·æ·»åŠ </td></tr>`;
                return;
            }
            let html = '';
            students.forEach(s => {
                html += `
                    <tr data-student-id="${s.id}">
                        <td>${escapeHtml(s.name)}</td>
                        <td>${s.age}</td>
                        <td class="student-actions">
                            <button class="edit-student-btn" data-action="editStudent" data-student-id="${s.id}">âœ ç¼–è¾‘</button>
                            <button class="delete-student-btn" data-action="deleteStudent" data-student-id="${s.id}">âœ• åˆ é™¤</button>
                        </td>
                    </tr>
                `;
            });
            tbody.innerHTML = html;
        }

        // æ·»åŠ ç­çº§
        document.getElementById('addClassBtn').addEventListener('click', async () => {
            const name = prompt('è¾“å…¥ç­çº§åç§°');
            if (!name) return;
            const res = await fetch('/api/classes', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ name })
            });
            if (res.ok) {
                const newClass = await res.json();
                classes.push(newClass);
                selectedClassId = newClass.id;
                renderClasses();
                loadStudents(selectedClassId);
            }
        });

        // ç­çº§åˆ—è¡¨ç‚¹å‡»äº‹ä»¶
        document.getElementById('classList').addEventListener('click', async (e) => {
            const btn = e.target.closest('button');
            if (btn) {
                e.stopPropagation();
                const action = btn.dataset.action;
                const classId = btn.dataset.classId;
                if (action === 'editClass') {
                    const newName = prompt('æ–°ç­çº§åç§°');
                    if (newName) {
                        const res = await fetch(`/api/classes/${classId}`, {
                            method: 'PUT',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ name: newName })
                        });
                        if (res.ok) loadClasses();
                    }
                } else if (action === 'deleteClass') {
                    if (confirm('ç¡®å®šåˆ é™¤ï¼Ÿ')) {
                        const res = await fetch(`/api/classes/${classId}`, { method: 'DELETE' });
                        if (res.ok) {
                            classes = classes.filter(c => c.id != classId);
                            if (selectedClassId == classId) selectedClassId = classes.length ? classes[0].id : null;
                            renderClasses();
                            if (selectedClassId) loadStudents(selectedClassId);
                        }
                    }
                }
                return;
            }
            const li = e.target.closest('.class-item');
            if (li) {
                selectedClassId = li.dataset.classId;
                renderClasses();
                loadStudents(selectedClassId);
            }
        });

        // æ·»åŠ å­¦ç”Ÿ
        document.getElementById('addStudentBtn').addEventListener('click', async () => {
            if (!selectedClassId) return alert('è¯·å…ˆé€‰æ‹©ç­çº§');
            const name = document.getElementById('studentName').value;
            const age = document.getElementById('studentAge').value;
            if (!name || !age) return alert('è¯·å¡«å†™å§“åå’Œå¹´é¾„');
            const res = await fetch(`/api/classes/${selectedClassId}/students`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ name, age })
            });
            if (res.ok) {
                document.getElementById('studentName').value = '';
                document.getElementById('studentAge').value = '';
                loadStudents(selectedClassId);
            }
        });

        // å­¦ç”Ÿè¡¨æ ¼ç¼–è¾‘/åˆ é™¤
        document.getElementById('studentsTbody').addEventListener('click', async (e) => {
            const btn = e.target.closest('button');
            if (!btn) return;
            const action = btn.dataset.action;
            const studentId = btn.dataset.studentId;
            if (action === 'editStudent') {
                const row = btn.closest('tr');
                const name = row.cells[0].innerText;
                const age = row.cells[1].innerText;
                document.getElementById('studentName').value = name;
                document.getElementById('studentAge').value = age;
                editStudentId = studentId;
                document.getElementById('addStudentBtn').textContent = 'ğŸ”„ æ›´æ–°å­¦ç”Ÿ';
                document.getElementById('cancelEditBtn').style.display = 'inline-block';
            } else if (action === 'deleteStudent') {
                if (confirm('ç¡®å®šåˆ é™¤ï¼Ÿ')) {
                    const res = await fetch(`/api/students/${studentId}`, { method: 'DELETE' });
                    if (res.ok) loadStudents(selectedClassId);
                }
            }
        });

        // æ›´æ–°å­¦ç”Ÿ
        document.getElementById('addStudentBtn').addEventListener('click', async (e) => {
            if (editStudentId) {
                e.preventDefault();
                const name = document.getElementById('studentName').value;
                const age = document.getElementById('studentAge').value;
                const res = await fetch(`/api/students/${editStudentId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, age })
                });
                if (res.ok) {
                    document.getElementById('studentName').value = '';
                    document.getElementById('studentAge').value = '';
                    editStudentId = null;
                    document.getElementById('addStudentBtn').textContent = 'â• æ·»åŠ å­¦ç”Ÿ';
                    document.getElementById('cancelEditBtn').style.display = 'none';
                    loadStudents(selectedClassId);
                }
            }
        });

        document.getElementById('cancelEditBtn').addEventListener('click', () => {
            document.getElementById('studentName').value = '';
            document.getElementById('studentAge').value = '';
            editStudentId = null;
            document.getElementById('addStudentBtn').textContent = 'â• æ·»åŠ å­¦ç”Ÿ';
            document.getElementById('cancelEditBtn').style.display = 'none';
        });

        async function logout() {
            await fetch('/api/logout', { method: 'POST' });
            window.location.href = "{{ url_for('login') }}";
        }

        // åˆå§‹åŒ–
        loadClasses();
    </script>
</body>
</html>